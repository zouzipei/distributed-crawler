# distributed-crawler
3.1 技术选型与相关开发文档
一、架构设计原则

1.1 问题场景聚焦
系统面向日均百万级网页抓取场景，重点解决三大核心问题：  
- 分布式协同：在多节点环境下实现任务动态分配与状态同步，避免重复爬取  
- 反爬对抗：当单个IP请求频率超过1次/秒时自动切换代理池，维持爬取可用性  
- 资源弹性：CPU利用率持续5分钟超过80%触发自动扩容，空闲时自动缩容

1.2 核心约束条件
- 网络环境：节点间内网带宽需稳定在1Gbps以上，公网出口需至少50个独立IP组成的代理池  
- 存储基线：按日均100万页面、平均页面大小150KB、保留30天计算，存储需求约为6.75TB  
- 延迟要求：从URL进入队列到数据可检索的全链路延迟需控制在5分钟以内

二、技术栈深度解析

2.1 消息队列选型
选择**Apache Kafka**作为核心消息中间件，主要基于以下考量：  
- 吞吐能力：实测单分区可承载3MB/s数据流，32分区满足百万级页面/日的分发需求  
- 精确一次语义：通过生产者幂等性和事务日志确保消息不丢失不重复  
- 生态集成：与Flink/Spark等流处理框架无缝对接，便于后期扩展实时分析功能
  
2.2 搜索引擎选型
采用**Elasticsearch 8.x**作为数据存储与检索引擎，关键特性包括：  
- 近实时搜索：通过refresh_interval=30s配置平衡写入性能与查询时效性  
- 分布式聚合：支持对10亿级文档进行复杂聚合查询，响应时间稳定在200ms内  
- 分词优化：集成IK分词器对中文网页内容进行语义切分，提升查询准确率

三、关键模块实现细节

3.1 URL分发引擎
采用双模式分发策略保障系统弹性：  

哈希分发模式  
def hash_dispatch(url: str) -> int:
    return sha256(url.encode()).digest()[0] % node_count
  优势：相同域名URL始终路由到固定节点，利于维持会话状态
动态负载均衡模式每30秒收集各节点负载指标（CPU/内存/队列深度），使用加权轮询算法分配新任务
   
3.2 反爬对抗体系
构建三级防御机制应对不同强度的反爬策略：  
- 基础防护层：遵守robots.txt规则，自动识别Crawl-delay指令控制请求间隔  
- 智能规避层：当连续3次请求返回403状态码时，自动切换代理IP并指数退避重试  
- 深度伪装层：随机生成符合主流浏览器的User-Agent头，动态调整TCP指纹特征

四、性能优化实践

4.1 爬取效率提升
通过异步IO模型实现高并发抓取，单个节点配置参数：  
- 并发连接数：500（受限于本地端口范围）  
- 超时控制：连接超时15s，响应读取超时30s  
- 重试策略：非200状态码最多重试3次，间隔时间[2^retry_count]秒

4.2 存储压缩方案
采用分级存储策略降低硬件成本：  
1. 原始HTML：使用Brotli算法压缩（压缩比≈7:1），存储于HDD阵列，保留7天  
2. 结构化数据：经解析后的文本内容以LZ4压缩（压缩比≈4:1），存储于NVMe SSD，永久保留
 
五、扩展性设计

5.1 水平扩展方案
Kafka集群扩容流程：  
1. 部署新Broker节点并加入集群  
2. 使用kafka-reassign-partitions工具将15%的分区迁移至新节点  
3. 监控流量均衡状态，逐步增加迁移比例至完全均衡

Elasticsearch热温架构：  
- 热节点：部署NVMe SSD磁盘，处理最近7天的高频查询  
- 温节点：使用大容量SATA HDD，存储历史数据供批量分析
  
5.2 灾备恢复机制
采用多可用区部署保障业务连续性：  
- 数据冗余：Kafka副本因子设置为3，ES分片副本数设为2  
- 故障转移：通过ZooKeeper实时监控节点状态，30秒内完成主节点切换  
- 增量备份：每日零点将增量数据上传至S3存储桶，保留30天快照

六、法律合规与伦理规范

6.1 数据采集边界
- 严格遵循robots.txt排除规则，设置全局禁止爬取路径：  
禁用路径 = ['/admin', '/account', '/api'] 
- 对敏感信息（身份证号、银行卡号等）进行实时脱敏处理
  
6.2 访问日志管理
- 日志字段：包含时间戳、源IP、目标URL、响应状态码  
- 存储策略：加密存储180天后自动删除，审计日志永久存档  
- 访问控制：通过RBAC模型限制日志查询权限，操作留痕可追溯  补充场景分析环节，明确要解决的问题和前提假设，比如按当前选型和架构总体预计需要xxx存储空间，xxx台服务器......。
